# 一、文件生命周期

文件生命周期定义的是：文件从“被系统接纳”到“被系统彻底删除”的全过程。

## 生命周期阶段

1. **Uploaded**
  - 含义：文件数据已写入存储，元数据已落库
  - 约束：不可下载
  - 角色：工程中间态

2. **Active**
  - 含义：文件对业务可见、可下载
  - 约束：唯一可下载状态
  - 角色：业务有效态

3. **Expired**
  - 含义：文件已超过业务有效期
  - 约束：不可下载，不参与业务
  - 角色：业务失效态

4. **Recycled**
  - 含义：逻辑删除
  - 约束：不可恢复业务使用
  - 角色：删除准备态
  - 说明：通过元数据区分系统清理 / 用户删除

5. **Destroyed**
  - 含义：文件及其存储数据已被物理删除
  - 约束：终态，不可逆
  - 角色：生命周期结束

# 二、生命周期推进规则

- **Uploaded → Active**：上传完成并校验通过
- **Active → Expired**：达到业务失效条件（时间 / 规则）
- **Expired → Recycled**：系统确认进入删除流程
- **Recycled → Destroyed**：物理删除成功

# 三、生命周期的核心约束（压缩成 3 条）

1. 只有 Active 可下载
2. Recycled 统一承载删除缓冲，不区分状态
3. 删除原因通过元数据区分，不扩展状态机

# 四、最容易被误解的 8 个坑点

1️⃣ **Uploaded ≠ 文件存在**
- 误解：Uploaded 表示“已经有一个文件了”。
- 正解：Uploaded 只是工程中间态，不保证可用，不参与任何业务。
- 规则：Uploaded 状态文件禁止下载、禁止引用、禁止依赖。

2️⃣ **Active 才是“文件的出生点”**
- 误解：文件一创建就算存在。
- 正解：只有进入 Active，文件才对系统和用户“真实存在”。
- 规则：所有下载、引用、计费、统计，只认 Active。

3️⃣ **Expired 不是“快删了”**
- 误解：Expired 就是马上要被删。
- 正解：Expired 表示业务已失效，不代表删除已启动。
- 规则：Expired 状态不允许任何业务使用，但允许审计和回溯。

4️⃣ **Recycled 不是“用户回收站”**
- 误解：Recycled 可以给用户当撤销入口。
- 正解：Recycled 是系统删除缓冲态，不是产品功能态。
- 规则：是否允许恢复，由 delete_source / delete_reason 决定，不由状态决定。

5️⃣ **状态不能表达“为什么”**
- 误解：用不同状态区分“系统删 / 用户删”。
- 正解：状态只表达“现在处在哪个阶段”，原因必须落在元数据。
- 规则：删除来源、删除原因只能用字段，不得扩展状态机。

6️⃣ **Destroyed 不等于“表里没数据”**
- 误解：Destroyed 就应该把记录删掉。
- 正解：Destroyed 是逻辑终态，不是数据消失。
- 规则：Destroyed 记录用于审计，不参与任何业务。
